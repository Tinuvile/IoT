<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <title>IoT数据发布者 - 首页</title>
</head>
<body>
    <th:block th:fragment="content">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h3 mb-0">
                    <i class="fas fa-satellite-dish text-primary me-2"></i>
                    IoT数据发布控制台
                </h2>
                <p class="text-muted mb-0">基于MQTT的物联网传感器数据发布系统</p>
            </div>
            <div>
                <span class="badge bg-success fs-6" id="system-status">系统运行中</span>
            </div>
        </div>

        <!-- 错误提示 -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            系统错误：<span th:text="${error}"></span>
        </div>

        <!-- 快速状态卡片 -->
        <div class="row mb-4">
            <!-- MQTT连接状态 -->
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card h-100" id="mqtt-status-card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-network-wired fa-3x text-primary"></i>
                        </div>
                        <h5 class="card-title">MQTT连接</h5>
                        <h3 class="text-primary mb-2" id="mqtt-status">检查中...</h3>
                        <p class="text-muted mb-0" id="mqtt-broker">-</p>
                    </div>
                </div>
            </div>

            <!-- 数据文件状态 -->
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card h-100" id="data-status-card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-database fa-3x text-success"></i>
                        </div>
                        <h5 class="card-title">数据文件</h5>
                        <h3 class="text-success mb-2" id="data-count">0</h3>
                        <p class="text-muted mb-0">条传感器数据</p>
                    </div>
                </div>
            </div>

            <!-- 发布状态 -->
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card h-100" id="publish-status-card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-paper-plane fa-3x text-warning"></i>
                        </div>
                        <h5 class="card-title">发布状态</h5>
                        <h3 class="text-warning mb-2" id="publish-status">未启动</h3>
                        <p class="text-muted mb-0" id="publish-rate">0 条/秒</p>
                    </div>
                </div>
            </div>

            <!-- 总发布量 -->
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-chart-line fa-3x text-info"></i>
                        </div>
                        <h5 class="card-title">总发布量</h5>
                        <h3 class="text-info mb-2" id="total-published">0</h3>
                        <p class="text-muted mb-0">累计数据条数</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速操作面板 -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>快速操作
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-success btn-action w-100" id="start-btn" onclick="startPublishing()">
                                    <i class="fas fa-play me-2"></i>开始发布
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-danger btn-action w-100" id="stop-btn" onclick="stopPublishing()">
                                    <i class="fas fa-stop me-2"></i>停止发布
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-warning btn-action w-100" onclick="resetStatistics()">
                                    <i class="fas fa-redo me-2"></i>重置统计
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <a href="/publisher" class="btn btn-primary btn-action w-100">
                                    <i class="fas fa-cog me-2"></i>高级控制
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 系统信息 -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>系统信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>应用名称</strong></td>
                                    <td>IoT Publisher</td>
                                </tr>
                                <tr>
                                    <td><strong>端口</strong></td>
                                    <td>8081</td>
                                </tr>
                                <tr>
                                    <td><strong>发布间隔</strong></td>
                                    <td id="publish-interval">-</td>
                                </tr>
                                <tr>
                                    <td><strong>批量大小</strong></td>
                                    <td id="batch-size">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 传感器数据概览 -->
        <div class="row">
            <div class="col-lg-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-thermometer-half fa-3x text-danger"></i>
                        </div>
                        <h5>温度传感器</h5>
                        <h4 class="text-danger" id="temperature-count">0</h4>
                        <p class="text-muted">已发布: <span id="temperature-published">0</span></p>
                        <button class="btn btn-outline-danger btn-sm" onclick="publishSingle('temperature')">
                            <i class="fas fa-paper-plane me-1"></i>发布一条
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-tint fa-3x text-primary"></i>
                        </div>
                        <h5>湿度传感器</h5>
                        <h4 class="text-primary" id="humidity-count">0</h4>
                        <p class="text-muted">已发布: <span id="humidity-published">0</span></p>
                        <button class="btn btn-outline-primary btn-sm" onclick="publishSingle('humidity')">
                            <i class="fas fa-paper-plane me-1"></i>发布一条
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-weight fa-3x text-success"></i>
                        </div>
                        <h5>气压传感器</h5>
                        <h4 class="text-success" id="pressure-count">0</h4>
                        <p class="text-muted">已发布: <span id="pressure-published">0</span></p>
                        <button class="btn btn-outline-success btn-sm" onclick="publishSingle('pressure')">
                            <i class="fas fa-paper-plane me-1"></i>发布一条
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <!-- 页面特定脚本 -->
    <th:block th:fragment="page-scripts">
        <script>
            // 页面加载完成后获取系统信息
            document.addEventListener('DOMContentLoaded', function() {
                fetchSystemInfo();
                fetchPublishStatus();
                
                // 每5秒刷新一次数据
                setInterval(fetchSystemInfo, 5000);
                setInterval(fetchPublishStatus, 2000);
            });
            
            // 获取系统信息
            function fetchSystemInfo() {
                fetch('/api/publisher/system-info')
                    .then(response => response.json())
                    .then(data => updateSystemInfo(data))
                    .catch(error => console.error('获取系统信息失败:', error));
            }
            
            // 获取发布状态
            function fetchPublishStatus() {
                fetch('/api/publisher/status')
                    .then(response => response.json())
                    .then(data => updatePublishStatus(data))
                    .catch(error => console.error('获取发布状态失败:', error));
            }
            
            // 更新系统信息
            function updateSystemInfo(systemInfo) {
                // MQTT状态
                const mqttStatus = document.getElementById('mqtt-status');
                const mqttBroker = document.getElementById('mqtt-broker');
                const mqttCard = document.getElementById('mqtt-status-card');
                
                if (systemInfo.mqttConnected) {
                    mqttStatus.textContent = '已连接';
                    mqttStatus.className = 'text-success mb-2';
                    mqttCard.className = 'card status-card status-running h-100';
                    mqttBroker.textContent = systemInfo.mqttConnectionInfo?.brokerUrl || '-';
                } else {
                    mqttStatus.textContent = '未连接';
                    mqttStatus.className = 'text-danger mb-2';
                    mqttCard.className = 'card status-card status-stopped h-100';
                    mqttBroker.textContent = '连接失败';
                }
                
                // 数据文件状态
                const dataCount = document.getElementById('data-count');
                const dataCard = document.getElementById('data-status-card');
                
                if (systemInfo.dataFilesExist) {
                    dataCount.textContent = formatNumber(systemInfo.totalDataCount);
                    dataCard.className = 'card status-card status-running h-100';
                } else {
                    dataCount.textContent = '文件缺失';
                    dataCard.className = 'card status-card status-stopped h-100';
                }
                
                // 传感器数据计数
                document.getElementById('temperature-count').textContent = formatNumber(systemInfo.temperatureCount);
                document.getElementById('humidity-count').textContent = formatNumber(systemInfo.humidityCount);
                document.getElementById('pressure-count').textContent = formatNumber(systemInfo.pressureCount);
                
                // 系统配置信息
                document.getElementById('publish-interval').textContent = systemInfo.publishInterval + 'ms';
                document.getElementById('batch-size').textContent = systemInfo.batchSize;
            }
            
            // 更新发布状态
            function updatePublishStatus(status) {
                const publishStatusEl = document.getElementById('publish-status');
                const publishRateEl = document.getElementById('publish-rate');
                const totalPublishedEl = document.getElementById('total-published');
                const publishCard = document.getElementById('publish-status-card');
                
                if (status.running) {
                    publishStatusEl.textContent = '运行中';
                    publishStatusEl.className = 'text-success mb-2';
                    publishCard.className = 'card status-card status-running h-100';
                    
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                } else {
                    publishStatusEl.textContent = '已停止';
                    publishStatusEl.className = 'text-danger mb-2';
                    publishCard.className = 'card status-card status-stopped h-100';
                    
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                }
                
                publishRateEl.textContent = status.publish_rate + ' 条/秒';
                totalPublishedEl.textContent = formatNumber(status.total_published);
                
                // 更新传感器发布计数
                document.getElementById('temperature-published').textContent = formatNumber(status.temperature_count);
                document.getElementById('humidity-published').textContent = formatNumber(status.humidity_count);
                document.getElementById('pressure-published').textContent = formatNumber(status.pressure_count);
            }
            
            // 开始发布
            function startPublishing() {
                const button = document.getElementById('start-btn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>启动中...';
                
                fetch('/api/publisher/start', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('发布服务已启动', 'success');
                    } else {
                        showToast('启动失败: ' + data.message, 'danger');
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-play me-2"></i>开始发布';
                    }
                })
                .catch(error => {
                    console.error('启动失败:', error);
                    showToast('启动失败: ' + error.message, 'danger');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-play me-2"></i>开始发布';
                });
            }
            
            // 停止发布
            function stopPublishing() {
                const button = document.getElementById('stop-btn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>停止中...';
                
                fetch('/api/publisher/stop', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('发布服务已停止', 'success');
                    } else {
                        showToast('停止失败: ' + data.message, 'danger');
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-stop me-2"></i>停止发布';
                    }
                })
                .catch(error => {
                    console.error('停止失败:', error);
                    showToast('停止失败: ' + error.message, 'danger');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-stop me-2"></i>停止发布';
                });
            }
            
            // 重置统计
            function resetStatistics() {
                if (confirm('确定要重置所有统计数据吗？')) {
                    fetch('/api/publisher/reset', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('统计数据已重置', 'success');
                        } else {
                            showToast('重置失败: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('重置失败:', error);
                        showToast('重置失败: ' + error.message, 'danger');
                    });
                }
            }
            
            // 发布单条数据
            function publishSingle(sensorType) {
                fetch(`/api/publisher/publish/${sensorType}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                    } else {
                        showToast('发布失败: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('发布失败:', error);
                    showToast('发布失败: ' + error.message, 'danger');
                });
            }
        </script>
    </th:block>
</body>
</html>