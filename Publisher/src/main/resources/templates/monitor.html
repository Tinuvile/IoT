<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout}">
<head>
    <title>IoT数据发布者 - 实时监控</title>
</head>
<body>
    <th:block th:fragment="content">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="h3 mb-0">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    实时监控面板
                </h2>
                <p class="text-muted mb-0">系统运行状态和数据流监控</p>
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="toggleAutoRefresh()">
                    <i class="fas fa-sync me-2" id="refresh-icon"></i>
                    <span id="refresh-text">自动刷新: 开启</span>
                </button>
            </div>
        </div>

        <!-- 实时状态卡片 -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">系统状态</h6>
                                <h4 class="mb-0" id="system-status">运行中</h4>
                            </div>
                            <div class="text-primary">
                                <i class="fas fa-server fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-success">
                                <i class="fas fa-circle me-1"></i>
                                在线
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">MQTT连接</h6>
                                <h4 class="mb-0" id="mqtt-status">未知</h4>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-network-wired fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small id="mqtt-broker" class="text-muted">检查中...</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">发布速率</h6>
                                <h4 class="mb-0" id="current-rate">0 条/秒</h4>
                            </div>
                            <div class="text-info">
                                <i class="fas fa-tachometer-alt fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                平均: <span id="avg-rate">0</span> 条/秒
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-3">
                <div class="card status-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="text-muted mb-1">总发布量</h6>
                                <h4 class="mb-0" id="total-count">0</h4>
                            </div>
                            <div class="text-warning">
                                <i class="fas fa-paper-plane fa-2x"></i>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                错误: <span id="error-count">0</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row mb-4">
            <!-- 发布速率趋势 -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>发布速率趋势
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="rateChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 传感器类型分布 -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>传感器类型分布
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="sensorChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据统计表格 -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>详细统计
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>传感器类型</th>
                                        <th>总数据量</th>
                                        <th>已发布</th>
                                        <th>进度</th>
                                        <th>发布率</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <i class="fas fa-thermometer-half text-danger me-2"></i>
                                            温度
                                        </td>
                                        <td id="temp-total-stat">0</td>
                                        <td id="temp-published-stat">0</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div id="temp-progress-stat" class="progress-bar bg-danger" role="progressbar" style="width: 0%">
                                                    <span id="temp-percentage">0%</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span id="temp-rate" class="badge bg-danger">0%</span></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <i class="fas fa-tint text-primary me-2"></i>
                                            湿度
                                        </td>
                                        <td id="humid-total-stat">0</td>
                                        <td id="humid-published-stat">0</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div id="humid-progress-stat" class="progress-bar bg-primary" role="progressbar" style="width: 0%">
                                                    <span id="humid-percentage">0%</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span id="humid-rate" class="badge bg-primary">0%</span></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <i class="fas fa-weight text-success me-2"></i>
                                            气压
                                        </td>
                                        <td id="pressure-total-stat">0</td>
                                        <td id="pressure-published-stat">0</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div id="pressure-progress-stat" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                                                    <span id="pressure-percentage">0%</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span id="pressure-rate" class="badge bg-success">0%</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 系统信息 -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>系统配置
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-6">发布间隔:</dt>
                            <dd class="col-sm-6" id="config-interval">-</dd>
                            
                            <dt class="col-sm-6">批量大小:</dt>
                            <dd class="col-sm-6" id="config-batch-size">-</dd>
                            
                            <dt class="col-sm-6">自动启动:</dt>
                            <dd class="col-sm-6" id="config-auto-start">-</dd>
                            
                            <dt class="col-sm-6">客户端ID:</dt>
                            <dd class="col-sm-6" id="config-client-id">-</dd>
                        </dl>
                        
                        <hr>
                        
                        <h6>运行时信息</h6>
                        <dl class="row">
                            <dt class="col-sm-6">启动时间:</dt>
                            <dd class="col-sm-6" id="start-time">-</dd>
                            
                            <dt class="col-sm-6">运行时长:</dt>
                            <dd class="col-sm-6" id="uptime">-</dd>
                            
                            <dt class="col-sm-6">最后发布:</dt>
                            <dd class="col-sm-6" id="last-publish">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- 实时日志 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-2"></i>实时活动日志
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                            <i class="fas fa-trash me-1"></i>清空日志
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="activity-log" class="realtime-data" style="height: 200px; overflow-y: auto;">
                            <div class="text-muted p-3">等待活动日志...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <!-- 页面特定脚本 -->
    <th:block th:fragment="page-scripts">
        <script>
            let rateChart, sensorChart;
            let rateData = [];
            let rateLabels = [];
            let autoRefreshEnabled = true;
            let refreshInterval;
            let rateHistory = [];
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', function() {
                initCharts();
                startAutoRefresh();
                fetchInitialData();
            });
            
            // 初始化图表
            function initCharts() {
                // 发布速率趋势图
                const rateCtx = document.getElementById('rateChart').getContext('2d');
                rateChart = new Chart(rateCtx, {
                    type: 'line',
                    data: {
                        labels: rateLabels,
                        datasets: [{
                            label: '发布速率 (条/秒)',
                            data: rateData,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '发布速率 (条/秒)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '时间'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // 传感器类型分布饼图
                const sensorCtx = document.getElementById('sensorChart').getContext('2d');
                sensorChart = new Chart(sensorCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['温度', '湿度', '气压'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(75, 192, 192, 0.8)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // 开始自动刷新
            function startAutoRefresh() {
                refreshInterval = setInterval(() => {
                    if (autoRefreshEnabled) {
                        fetchData();
                    }
                }, 2000); // 每2秒刷新一次
            }
            
            // 获取初始数据
            function fetchInitialData() {
                fetchSystemInfo();
                fetchPublishStatus();
            }
            
            // 获取数据
            function fetchData() {
                fetchSystemInfo();
                fetchPublishStatus();
            }
            
            // 获取系统信息
            function fetchSystemInfo() {
                fetch('/api/publisher/system-info')
                    .then(response => response.json())
                    .then(data => updateSystemInfo(data))
                    .catch(error => {
                        console.error('获取系统信息失败:', error);
                        addLogEntry('ERROR', '获取系统信息失败: ' + error.message);
                    });
            }
            
            // 获取发布状态
            function fetchPublishStatus() {
                fetch('/api/publisher/status')
                    .then(response => response.json())
                    .then(data => updatePublishStatus(data))
                    .catch(error => {
                        console.error('获取发布状态失败:', error);
                        addLogEntry('ERROR', '获取发布状态失败: ' + error.message);
                    });
            }
            
            // 更新系统信息
            function updateSystemInfo(systemInfo) {
                // 更新MQTT状态
                const mqttStatusEl = document.getElementById('mqtt-status');
                const mqttBrokerEl = document.getElementById('mqtt-broker');
                
                if (systemInfo.mqttConnected) {
                    mqttStatusEl.textContent = '已连接';
                    mqttStatusEl.className = 'mb-0 text-success';
                    mqttBrokerEl.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>${systemInfo.mqttConnectionInfo?.brokerUrl || '-'}`;
                } else {
                    mqttStatusEl.textContent = '未连接';
                    mqttStatusEl.className = 'mb-0 text-danger';
                    mqttBrokerEl.innerHTML = '<i class="fas fa-times-circle text-danger me-1"></i>连接失败';
                }
                
                // 更新配置信息
                document.getElementById('config-interval').textContent = systemInfo.publishInterval + 'ms';
                document.getElementById('config-batch-size').textContent = systemInfo.batchSize;
                document.getElementById('config-auto-start').textContent = systemInfo.autoStart ? '是' : '否';
                document.getElementById('config-client-id').textContent = systemInfo.mqttConnectionInfo?.clientId || '-';
                
                // 更新统计表格
                updateStatTable('temp', systemInfo.temperatureCount, 0);
                updateStatTable('humid', systemInfo.humidityCount, 0);
                updateStatTable('pressure', systemInfo.pressureCount, 0);
            }
            
            // 更新发布状态
            function updatePublishStatus(status) {
                // 更新基本状态
                document.getElementById('system-status').textContent = status.running ? '运行中' : '已停止';
                document.getElementById('current-rate').textContent = status.publish_rate + ' 条/秒';
                document.getElementById('total-count').textContent = formatNumber(status.total_published);
                document.getElementById('error-count').textContent = formatNumber(status.error_count);
                
                // 更新速率历史
                rateHistory.push(status.publish_rate);
                if (rateHistory.length > 50) {
                    rateHistory.shift();
                }
                
                // 计算平均速率
                const avgRate = rateHistory.length > 0 ? 
                    (rateHistory.reduce((a, b) => a + b, 0) / rateHistory.length).toFixed(1) : 0;
                document.getElementById('avg-rate').textContent = avgRate;
                
                // 更新时间信息
                if (status.start_time) {
                    document.getElementById('start-time').textContent = formatDateTime(status.start_time);
                    
                    const startTime = new Date(status.start_time);
                    const now = new Date();
                    const uptime = Math.floor((now - startTime) / 1000);
                    document.getElementById('uptime').textContent = formatDuration(uptime);
                }
                
                if (status.last_publish_time) {
                    document.getElementById('last-publish').textContent = formatDateTime(status.last_publish_time);
                }
                
                // 更新统计表格
                updateStatTable('temp', systemInfo?.temperatureCount || 0, status.temperature_count);
                updateStatTable('humid', systemInfo?.humidityCount || 0, status.humidity_count);
                updateStatTable('pressure', systemInfo?.pressureCount || 0, status.pressure_count);
                
                // 更新图表
                updateRateChart(status.publish_rate);
                updateSensorChart(status.temperature_count, status.humidity_count, status.pressure_count);
                
                // 添加活动日志
                if (status.running && status.publish_rate > 0) {
                    addLogEntry('INFO', `发布速率: ${status.publish_rate} 条/秒, 总计: ${formatNumber(status.total_published)}`);
                }
            }
            
            // 更新速率图表
            function updateRateChart(rate) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
                
                rateData.push(rate);
                rateLabels.push(timeStr);
                
                // 保持最近50个数据点
                if (rateData.length > 50) {
                    rateData.shift();
                    rateLabels.shift();
                }
                
                rateChart.update('none');
            }
            
            // 更新传感器分布图表
            function updateSensorChart(tempCount, humidCount, pressureCount) {
                sensorChart.data.datasets[0].data = [tempCount, humidCount, pressureCount];
                sensorChart.update('none');
            }
            
            // 更新统计表格
            function updateStatTable(sensorPrefix, total, published) {
                document.getElementById(sensorPrefix + '-total-stat').textContent = formatNumber(total);
                document.getElementById(sensorPrefix + '-published-stat').textContent = formatNumber(published);
                
                const percentage = total > 0 ? (published / total * 100) : 0;
                const progressBar = document.getElementById(sensorPrefix + '-progress-stat');
                const percentageSpan = document.getElementById(sensorPrefix + '-percentage');
                const rateSpan = document.getElementById(sensorPrefix + '-rate');
                
                progressBar.style.width = Math.min(percentage, 100) + '%';
                percentageSpan.textContent = percentage.toFixed(1) + '%';
                rateSpan.textContent = percentage.toFixed(1) + '%';
            }
            
            // 添加活动日志条目
            function addLogEntry(level, message) {
                const logContainer = document.getElementById('activity-log');
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
                
                const levelColors = {
                    'INFO': 'text-info',
                    'WARN': 'text-warning',
                    'ERROR': 'text-danger',
                    'SUCCESS': 'text-success'
                };
                
                const logEntry = document.createElement('div');
                logEntry.className = 'mb-1';
                logEntry.innerHTML = `
                    <span class="text-muted">[${timeStr}]</span>
                    <span class="${levelColors[level] || 'text-info'}">[${level}]</span>
                    ${message}
                `;
                
                // 移除"等待活动日志"提示
                const waitingMsg = logContainer.querySelector('.text-muted');
                if (waitingMsg && waitingMsg.textContent.includes('等待活动日志')) {
                    waitingMsg.remove();
                }
                
                logContainer.appendChild(logEntry);
                
                // 保持最近100条日志
                const logs = logContainer.children;
                if (logs.length > 100) {
                    logContainer.removeChild(logs[0]);
                }
                
                // 自动滚动到底部
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            // 切换自动刷新
            function toggleAutoRefresh() {
                autoRefreshEnabled = !autoRefreshEnabled;
                const refreshText = document.getElementById('refresh-text');
                const refreshIcon = document.getElementById('refresh-icon');
                
                if (autoRefreshEnabled) {
                    refreshText.textContent = '自动刷新: 开启';
                    refreshIcon.className = 'fas fa-sync me-2';
                    addLogEntry('INFO', '自动刷新已开启');
                } else {
                    refreshText.textContent = '自动刷新: 关闭';
                    refreshIcon.className = 'fas fa-pause me-2';
                    addLogEntry('WARN', '自动刷新已关闭');
                }
            }
            
            // 清空日志
            function clearLog() {
                const logContainer = document.getElementById('activity-log');
                logContainer.innerHTML = '<div class="text-muted p-3">日志已清空</div>';
            }
            
            // 格式化持续时间
            function formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${hours}h ${minutes}m ${secs}s`;
            }
            
            // WebSocket状态更新（覆盖全局函数）
            function updatePublishStatus(status) {
                // 这里会被WebSocket调用，同样的逻辑
                updatePublishStatus(status);
            }
            
            function updateSystemInfo(systemInfo) {
                // 这里会被WebSocket调用，同样的逻辑
                updateSystemInfo(systemInfo);
            }
        </script>
    </th:block>
</body>
</html>