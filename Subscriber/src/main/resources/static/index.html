<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT数据订阅者 - 首页</title>
    
    <!-- Bootstrap CSS (本地化) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome (本地化) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .status-running {
            border-left: 5px solid #28a745;
        }
        .status-stopped {
            border-left: 5px solid #dc3545;
        }
        .status-warning {
            border-left: 5px solid #ffc107;
        }
        .btn-action {
            border-radius: 25px;
            padding: 10px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .realtime-data {
            font-family: 'Monaco', 'Consolas', monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            font-size: 14px;
        }
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
        .progress-animated {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            animation: progress-shine 1.5s infinite;
        }
        @keyframes progress-shine {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-satellite-dish text-success me-2"></i>
                IoT数据订阅者
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-2 sidebar px-0">
                <div class="p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">
                                <i class="fas fa-home me-2"></i>首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subscriber.html">
                                <i class="fas fa-download me-2"></i>数据订阅
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="monitor.html">
                                <i class="fas fa-chart-line me-2"></i>数据监控
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <hr class="text-white-50">
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="layout.html">
                                <i class="fas fa-heartbeat me-2"></i>系统布局
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showToast('系统信息功能需要服务器支持', 'info')">
                                <i class="fas fa-cogs me-2"></i>系统信息
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main class="col-md-10 main-content p-4">
                <!-- 页面标题 -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h3 mb-0">
                            <i class="fas fa-download text-success me-2"></i>
                            IoT数据订阅控制台
                        </h2>
                        <p class="text-muted mb-0">基于MQTT的物联网传感器数据接收与存储系统</p>
                    </div>
                    <div>
                        <span class="badge bg-success fs-6" id="system-status">系统运行中</span>
                    </div>
                </div>

                <!-- 快速状态卡片 -->
                <div class="row mb-4">
                    <!-- MQTT连接状态 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100" id="mqtt-status-card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-network-wired fa-3x text-primary"></i>
                                </div>
                                <h5 class="card-title">MQTT连接</h5>
                                <h3 class="text-muted mb-2" id="mqtt-status">检查中...</h3>
                                <p class="text-muted mb-0" id="mqtt-broker">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- 订阅状态 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100" id="subscribe-status-card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-download fa-3x text-success"></i>
                                </div>
                                <h5 class="card-title">订阅状态</h5>
                                <h3 class="text-muted mb-2" id="subscribe-status">检查中...</h3>
                                <p class="text-muted mb-0" id="subscribe-rate">- 条/秒</p>
                            </div>
                        </div>
                    </div>

                    <!-- 数据存储 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100" id="storage-status-card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-database fa-3x text-info"></i>
                                </div>
                                <h5 class="card-title">数据存储</h5>
                                <h3 class="text-muted mb-2" id="total-stored">检查中...</h3>
                                <p class="text-muted mb-0">条存储数据</p>
                            </div>
                        </div>
                    </div>

                    <!-- 总接收量 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-chart-line fa-3x text-warning"></i>
                                </div>
                                <h5 class="card-title">总接收量</h5>
                                <h3 class="text-warning mb-2" id="total-received">-</h3>
                                <p class="text-muted mb-0">累计数据条数</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作面板 -->
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-play-circle me-2"></i>快速操作
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-success btn-action w-100" id="start-btn" onclick="startSubscribing()">
                                            <i class="fas fa-play me-2"></i>开始订阅
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-danger btn-action w-100" id="stop-btn" onclick="stopSubscribing()" disabled>
                                            <i class="fas fa-stop me-2"></i>停止订阅
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-warning btn-action w-100" onclick="refreshAnalysis()">
                                            <i class="fas fa-redo me-2"></i>刷新分析
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <a href="subscriber.html" class="btn btn-primary btn-action w-100">
                                            <i class="fas fa-cog me-2"></i>高级控制
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 系统信息 -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>系统信息
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>应用名称</strong></td>
                                            <td>IoT Subscriber</td>
                                        </tr>
                                        <tr>
                                            <td><strong>端口</strong></td>
                                            <td>8082</td>
                                        </tr>
                                        <tr>
                                            <td><strong>订阅主题</strong></td>
                                            <td id="subscribe-topics">iot/sensors/+</td>
                                        </tr>
                                        <tr>
                                            <td><strong>数据库连接</strong></td>
                                            <td id="db-status">检查中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 传感器数据概览 -->
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-thermometer-half fa-3x text-danger"></i>
                                </div>
                                <h5>温度数据</h5>
                                <h4 class="text-danger" id="temperature-received">-</h4>
                                <p class="text-muted">最新值: <span id="temperature-latest">-</span>°C</p>
                                <button class="btn btn-outline-danger btn-sm" onclick="viewLatestData('temperature')">
                                    <i class="fas fa-eye me-1"></i>查看详情
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-tint fa-3x text-primary"></i>
                                </div>
                                <h5>湿度数据</h5>
                                <h4 class="text-primary" id="humidity-received">-</h4>
                                <p class="text-muted">最新值: <span id="humidity-latest">-</span>%</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewLatestData('humidity')">
                                    <i class="fas fa-eye me-1"></i>查看详情
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-weight fa-3x text-success"></i>
                                </div>
                                <h5>气压数据</h5>
                                <h4 class="text-success" id="pressure-received">-</h4>
                                <p class="text-muted">最新值: <span id="pressure-latest">-</span>hPa</p>
                                <button class="btn btn-outline-success btn-sm" onclick="viewLatestData('pressure')">
                                    <i class="fas fa-eye me-1"></i>查看详情
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 通用JavaScript -->
    <script>
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }
        
        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // 工具函数：格式化时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '未知';
            return new Date(dateTimeStr).toLocaleString('zh-CN');
        }
        
        // 工具函数：格式化数字
        function formatNumber(num) {
            return new Intl.NumberFormat('zh-CN').format(num);
        }
        
        // 工具函数：显示Toast消息
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // 3秒后自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // 创建Toast容器
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        // 按钮状态锁，防止轮询干扰loading状态
        let isStartButtonLoading = false;
        let isStopButtonLoading = false;
        
        // 页面加载后立即获取数据
        document.addEventListener('DOMContentLoaded', function() {
            fetchSystemInfo();
            fetchSubscriberStatus();
            fetchLatestData();
            
            // 每5秒刷新一次数据
            setInterval(fetchSystemInfo, 5000);
            setInterval(fetchSubscriberStatus, 3000);
            setInterval(fetchLatestData, 10000);
        });
        
        // 获取系统信息
        function fetchSystemInfo() {
            fetch('/api/subscriber/system-info')
                .then(response => response.json())
                .then(data => updateSystemInfo(data))
                .catch(error => {
                    console.error('获取系统信息失败:', error);
                    // 不显示Toast，避免过度提醒
                });
        }
        
        // 获取订阅状态
        function fetchSubscriberStatus() {
            fetch('/api/subscriber/status')
                .then(response => response.json())
                .then(data => updateSubscriberStatus(data))
                .catch(error => {
                    console.error('获取订阅状态失败:', error);
                    // 不显示Toast，避免过度提醒
                });
        }

        // 获取最新数据
        function fetchLatestData() {
            fetch('/api/subscriber/data/latest?limit=1')
                .then(response => response.json())
                .then(data => updateLatestDataDisplay(data))
                .catch(error => {
                    console.error('获取最新数据失败:', error);
                });
        }
        
        // 更新系统信息
        function updateSystemInfo(systemInfo) {
            // MQTT状态
            const mqttStatus = document.getElementById('mqtt-status');
            const mqttBroker = document.getElementById('mqtt-broker');
            const mqttCard = document.getElementById('mqtt-status-card');
            
            if (systemInfo.mqttConnected) {
                mqttStatus.textContent = '已连接';
                mqttStatus.className = 'text-success mb-2';
                mqttCard.className = 'card status-card status-running h-100';
                mqttBroker.textContent = systemInfo.mqttConnectionInfo?.brokerUrl || '-';
            } else {
                mqttStatus.textContent = '未连接';
                mqttStatus.className = 'text-danger mb-2';
                mqttCard.className = 'card status-card status-stopped h-100';
                mqttBroker.textContent = '连接失败';
            }
            
            // 数据存储状态
            const totalStored = document.getElementById('total-stored');
            const storageCard = document.getElementById('storage-status-card');
            
            totalStored.textContent = formatNumber(systemInfo.totalDataCount || 0);
            storageCard.className = 'card status-card status-running h-100';
            
            // 传感器数据计数
            document.getElementById('temperature-received').textContent = formatNumber(systemInfo.temperatureCount || 0);
            document.getElementById('humidity-received').textContent = formatNumber(systemInfo.humidityCount || 0);
            document.getElementById('pressure-received').textContent = formatNumber(systemInfo.pressureCount || 0);
        }
        
        // 更新订阅状态
        function updateSubscriberStatus(status) {
            const subscribeStatusEl = document.getElementById('subscribe-status');
            const subscribeCard = document.getElementById('subscribe-status-card');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const totalReceived = document.getElementById('total-received');
            
            if (status.subscribing) {
                subscribeStatusEl.textContent = '订阅中';
                subscribeStatusEl.className = 'text-success mb-2';
                subscribeCard.className = 'card status-card status-running h-100';
                
                // 只有在按钮不在loading状态时才更新
                if (!isStartButtonLoading) {
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
                }
                if (!isStopButtonLoading) {
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
                }
            } else {
                subscribeStatusEl.textContent = '未订阅';
                subscribeStatusEl.className = 'text-danger mb-2';
                subscribeCard.className = 'card status-card status-stopped h-100';
                
                // 只有在按钮不在loading状态时才更新
                if (!isStartButtonLoading) {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
                }
                if (!isStopButtonLoading) {
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
                }
            }
            
            // 更新总接收量
            const totalCount = (status.temperatureCount || 0) + (status.humidityCount || 0) + (status.pressureCount || 0);
            totalReceived.textContent = formatNumber(totalCount);
        }

        // 更新最新数据显示
        function updateLatestDataDisplay(data) {
            if (data.temperature && data.temperature.length > 0) {
                document.getElementById('temperature-latest').textContent = data.temperature[0].value;
            }
            if (data.humidity && data.humidity.length > 0) {
                document.getElementById('humidity-latest').textContent = data.humidity[0].value;
            }
            if (data.pressure && data.pressure.length > 0) {
                document.getElementById('pressure-latest').textContent = data.pressure[0].value;
            }
        }
        
        // 开始订阅
        function startSubscribing() {
            const button = document.getElementById('start-btn');
            isStartButtonLoading = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>启动中...';
            
            fetch('/api/subscriber/start', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('订阅服务已启动', 'success');
                } else {
                    showToast('启动失败: ' + data.message, 'danger');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
                }
            })
            .catch(error => {
                console.error('启动失败:', error);
                showToast('启动失败: ' + error.message, 'danger');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
            })
            .finally(() => {
                isStartButtonLoading = false;
            });
        }
        
        // 停止订阅
        function stopSubscribing() {
            const button = document.getElementById('stop-btn');
            isStopButtonLoading = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>停止中...';
            
            fetch('/api/subscriber/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('订阅服务已停止', 'success');
                } else {
                    showToast('停止失败: ' + data.message, 'danger');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
                }
            })
            .catch(error => {
                console.error('停止失败:', error);
                showToast('停止失败: ' + error.message, 'danger');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
            })
            .finally(() => {
                isStopButtonLoading = false;
            });
        }
        
        // 刷新分析结果
        function refreshAnalysis() {
            // 找到刷新按钮
            const refreshButtons = document.querySelectorAll('button[onclick="refreshAnalysis()"]');
            const refreshButton = refreshButtons[0];
            
            if (refreshButton) {
                const originalHtml = refreshButton.innerHTML;
                refreshButton.disabled = true;
                refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>刷新中...';
                
                fetch('/api/subscriber/analysis/refresh', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('分析结果已刷新', 'success');
                        fetchLatestData(); // 重新获取数据
                    } else {
                        showToast('刷新失败: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('刷新失败:', error);
                    showToast('刷新失败: ' + error.message, 'danger');
                })
                .finally(() => {
                    refreshButton.disabled = false;
                    refreshButton.innerHTML = originalHtml;
                });
            }
        }
        
        // 查看最新数据详情
        function viewLatestData(sensorType) {
            window.location.href = `monitor.html#${sensorType}`;
        }
    </script>
</body>
</html>