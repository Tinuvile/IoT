<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT数据发布者 - 首页</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SockJS and STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@6.1.0/bundles/stomp.umd.min.js"></script>
    
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .status-running {
            border-left: 5px solid #28a745;
        }
        .status-stopped {
            border-left: 5px solid #dc3545;
        }
        .status-warning {
            border-left: 5px solid #ffc107;
        }
        .btn-action {
            border-radius: 25px;
            padding: 10px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .realtime-data {
            font-family: 'Monaco', 'Consolas', monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            font-size: 14px;
        }
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
        .progress-animated {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            animation: progress-shine 1.5s infinite;
        }
        @keyframes progress-shine {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-satellite-dish text-primary me-2"></i>
                IoT数据发布者
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-2 sidebar px-0">
                <div class="p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">
                                <i class="fas fa-home me-2"></i>首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="publisher.html">
                                <i class="fas fa-paper-plane me-2"></i>数据发布
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="monitor.html">
                                <i class="fas fa-chart-line me-2"></i>实时监控
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <hr class="text-white-50">
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="layout.html">
                                <i class="fas fa-heartbeat me-2"></i>系统布局
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showToast('系统信息功能需要服务器支持', 'info')">
                                <i class="fas fa-cogs me-2"></i>系统信息
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main class="col-md-10 main-content p-4">
                <!-- 页面标题 -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h3 mb-0">
                            <i class="fas fa-satellite-dish text-primary me-2"></i>
                            IoT数据发布控制台
                        </h2>
                        <p class="text-muted mb-0">基于MQTT的物联网传感器数据发布系统</p>
                    </div>
                    <div>
                        <span class="badge bg-success fs-6" id="system-status">系统运行中</span>
                    </div>
                </div>

                <!-- 快速状态卡片 -->
                <div class="row mb-4">
                    <!-- MQTT连接状态 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100" id="mqtt-status-card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-network-wired fa-3x text-primary"></i>
                                </div>
                                <h5 class="card-title">MQTT连接</h5>
                                <h3 class="text-muted mb-2" id="mqtt-status">检查中...</h3>
                                <p class="text-muted mb-0" id="mqtt-broker">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- 数据文件状态 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100" id="data-status-card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-database fa-3x text-success"></i>
                                </div>
                                <h5 class="card-title">数据文件</h5>
                                <h3 class="text-muted mb-2" id="data-count">检查中...</h3>
                                <p class="text-muted mb-0">条传感器数据</p>
                            </div>
                        </div>
                    </div>

                    <!-- 发布状态 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100" id="publish-status-card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-paper-plane fa-3x text-warning"></i>
                                </div>
                                <h5 class="card-title">发布状态</h5>
                                <h3 class="text-muted mb-2" id="publish-status">检查中...</h3>
                                <p class="text-muted mb-0" id="publish-rate">- 条/秒</p>
                            </div>
                        </div>
                    </div>

                    <!-- 总发布量 -->
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-chart-line fa-3x text-info"></i>
                                </div>
                                <h5 class="card-title">总发布量</h5>
                                <h3 class="text-info mb-2" id="total-published">-</h3>
                                <p class="text-muted mb-0">累计数据条数</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作面板 -->
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-play-circle me-2"></i>快速操作
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-success btn-action w-100" id="start-btn" onclick="startPublishing()">
                                            <i class="fas fa-play me-2"></i>开始发布
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-danger btn-action w-100" id="stop-btn" onclick="stopPublishing()" disabled>
                                            <i class="fas fa-stop me-2"></i>停止发布
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-warning btn-action w-100" onclick="resetStatistics()">
                                            <i class="fas fa-redo me-2"></i>重置统计
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <a href="publisher.html" class="btn btn-primary btn-action w-100">
                                            <i class="fas fa-cog me-2"></i>高级控制
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 系统信息 -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>系统信息
                                </h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>应用名称</strong></td>
                                            <td>IoT Publisher</td>
                                        </tr>
                                        <tr>
                                            <td><strong>端口</strong></td>
                                            <td>8081</td>
                                        </tr>
                                        <tr>
                                            <td><strong>发布间隔</strong></td>
                                            <td id="publish-interval">-</td>
                                        </tr>
                                        <tr>
                                            <td><strong>批量大小</strong></td>
                                            <td id="batch-size">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 传感器数据概览 -->
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-thermometer-half fa-3x text-danger"></i>
                                </div>
                                <h5>温度传感器</h5>
                                <h4 class="text-danger" id="temperature-count">-</h4>
                                <p class="text-muted">已发布: <span id="temperature-published">-</span></p>
                                <button class="btn btn-outline-danger btn-sm" onclick="publishSingle('temperature')">
                                    <i class="fas fa-paper-plane me-1"></i>发布一条
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-tint fa-3x text-primary"></i>
                                </div>
                                <h5>湿度传感器</h5>
                                <h4 class="text-primary" id="humidity-count">-</h4>
                                <p class="text-muted">已发布: <span id="humidity-published">-</span></p>
                                <button class="btn btn-outline-primary btn-sm" onclick="publishSingle('humidity')">
                                    <i class="fas fa-paper-plane me-1"></i>发布一条
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-weight fa-3x text-success"></i>
                                </div>
                                <h5>气压传感器</h5>
                                <h4 class="text-success" id="pressure-count">-</h4>
                                <p class="text-muted">已发布: <span id="pressure-published">-</span></p>
                                <button class="btn btn-outline-success btn-sm" onclick="publishSingle('pressure')">
                                    <i class="fas fa-paper-plane me-1"></i>发布一条
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 通用JavaScript -->
    <script>
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }
        
        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // 工具函数：格式化时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '未知';
            return new Date(dateTimeStr).toLocaleString('zh-CN');
        }
        
        // 工具函数：格式化数字
        function formatNumber(num) {
            return new Intl.NumberFormat('zh-CN').format(num);
        }
        
        // 工具函数：显示Toast消息
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // 3秒后自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // 创建Toast容器
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        // 按钮状态锁，防止轮询干扰loading状态
        let isStartButtonLoading = false;
        let isStopButtonLoading = false;
        
        // 页面加载后立即获取数据
        document.addEventListener('DOMContentLoaded', function() {
            fetchSystemInfo();
            fetchPublishStatus();
            
            // 每5秒刷新一次数据
            setInterval(fetchSystemInfo, 5000);
            setInterval(fetchPublishStatus, 2000);
        });
        
        // 获取系统信息
        function fetchSystemInfo() {
            fetch('/api/publisher/system-info')
                .then(response => response.json())
                .then(data => updateSystemInfo(data))
                .catch(error => {
                    console.error('获取系统信息失败:', error);
                    showToast('获取系统信息失败', 'danger');
                });
        }
        
        // 获取发布状态
        function fetchPublishStatus() {
            fetch('/api/publisher/status')
                .then(response => response.json())
                .then(data => updatePublishStatus(data))
                .catch(error => {
                    console.error('获取发布状态失败:', error);
                    showToast('获取发布状态失败', 'danger');
                });
        }
        
        // 更新系统信息
        function updateSystemInfo(systemInfo) {
            // MQTT状态
            const mqttStatus = document.getElementById('mqtt-status');
            const mqttBroker = document.getElementById('mqtt-broker');
            const mqttCard = document.getElementById('mqtt-status-card');
            
            if (systemInfo.mqttConnected) {
                mqttStatus.textContent = '已连接';
                mqttStatus.className = 'text-success mb-2';
                mqttCard.className = 'card status-card status-running h-100';
                mqttBroker.textContent = systemInfo.mqttConnectionInfo?.brokerUrl || '-';
            } else {
                mqttStatus.textContent = '未连接';
                mqttStatus.className = 'text-danger mb-2';
                mqttCard.className = 'card status-card status-stopped h-100';
                mqttBroker.textContent = '连接失败';
            }
            
            // 数据文件状态
            const dataCount = document.getElementById('data-count');
            const dataCard = document.getElementById('data-status-card');
            
            if (systemInfo.dataFilesExist) {
                dataCount.textContent = formatNumber(systemInfo.totalDataCount);
                dataCard.className = 'card status-card status-running h-100';
            } else {
                dataCount.textContent = '文件缺失';
                dataCard.className = 'card status-card status-stopped h-100';
            }
            
            // 传感器数据计数
            document.getElementById('temperature-count').textContent = formatNumber(systemInfo.temperatureCount);
            document.getElementById('humidity-count').textContent = formatNumber(systemInfo.humidityCount);
            document.getElementById('pressure-count').textContent = formatNumber(systemInfo.pressureCount);
            
            // 系统配置信息
            document.getElementById('publish-interval').textContent = systemInfo.publishInterval + 'ms';
            document.getElementById('batch-size').textContent = systemInfo.batchSize;
        }
        
        // 更新发布状态
        function updatePublishStatus(status) {
            const publishStatusEl = document.getElementById('publish-status');
            const publishRateEl = document.getElementById('publish-rate');
            const totalPublishedEl = document.getElementById('total-published');
            const publishCard = document.getElementById('publish-status-card');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            if (status.is_running) {
                publishStatusEl.textContent = '运行中';
                publishStatusEl.className = 'text-success mb-2';
                publishCard.className = 'card status-card status-running h-100';
                
                // 只有在按钮不在loading状态时才更新
                if (!isStartButtonLoading) {
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-play me-2"></i>开始发布';
                }
                if (!isStopButtonLoading) {
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>停止发布';
                }
            } else {
                publishStatusEl.textContent = '已停止';
                publishStatusEl.className = 'text-danger mb-2';
                publishCard.className = 'card status-card status-stopped h-100';
                
                // 只有在按钮不在loading状态时才更新
                if (!isStartButtonLoading) {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play me-2"></i>开始发布';
                }
                if (!isStopButtonLoading) {
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>停止发布';
                }
            }
            
            publishRateEl.textContent = status.publish_rate + ' 条/秒';
            totalPublishedEl.textContent = formatNumber(status.total_published);
            
            // 更新传感器发布计数
            document.getElementById('temperature-published').textContent = formatNumber(status.temperature_count);
            document.getElementById('humidity-published').textContent = formatNumber(status.humidity_count);
            document.getElementById('pressure-published').textContent = formatNumber(status.pressure_count);
        }
        
        // 开始发布
        function startPublishing() {
            const button = document.getElementById('start-btn');
            isStartButtonLoading = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>启动中...';
            
            fetch('/api/publisher/start', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('发布服务已启动', 'success');
                } else {
                    showToast('启动失败: ' + data.message, 'danger');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-play me-2"></i>开始发布';
                }
            })
            .catch(error => {
                console.error('启动失败:', error);
                showToast('启动失败: ' + error.message, 'danger');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play me-2"></i>开始发布';
            })
            .finally(() => {
                isStartButtonLoading = false;
            });
        }
        
        // 停止发布
        function stopPublishing() {
            const button = document.getElementById('stop-btn');
            isStopButtonLoading = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>停止中...';
            
            fetch('/api/publisher/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('发布服务已停止', 'success');
                } else {
                    showToast('停止失败: ' + data.message, 'danger');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-stop me-2"></i>停止发布';
                }
            })
            .catch(error => {
                console.error('停止失败:', error);
                showToast('停止失败: ' + error.message, 'danger');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-stop me-2"></i>停止发布';
            })
            .finally(() => {
                isStopButtonLoading = false;
            });
        }
        
        // 重置统计
        function resetStatistics() {
            if (confirm('确定要重置所有统计数据吗？')) {
                // 找到重置按钮
                const resetButtons = document.querySelectorAll('button[onclick="resetStatistics()"]');
                const resetButton = resetButtons[0];
                
                if (resetButton) {
                    const originalHtml = resetButton.innerHTML;
                    resetButton.disabled = true;
                    resetButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>重置中...';
                    
                    fetch('/api/publisher/reset', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('统计数据已重置', 'success');
                        } else {
                            showToast('重置失败: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('重置失败:', error);
                        showToast('重置失败: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        resetButton.disabled = false;
                        resetButton.innerHTML = originalHtml;
                    });
                } else {
                    // 如果找不到按钮，直接调用API
                    fetch('/api/publisher/reset', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('统计数据已重置', 'success');
                        } else {
                            showToast('重置失败: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('重置失败:', error);
                        showToast('重置失败: ' + error.message, 'danger');
                    });
                }
            }
        }
        
        // 发布单条数据
        function publishSingle(sensorType) {
            // 找到对应的按钮
            const buttons = document.querySelectorAll(`button[onclick="publishSingle('${sensorType}')"]`);
            const button = buttons[0];
            
            if (button && !button.disabled) {
                const originalHtml = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>发布中...';
                
                fetch(`/api/publisher/publish/${sensorType}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                    } else {
                        showToast('发布失败: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('发布失败:', error);
                    showToast('发布失败: ' + error.message, 'danger');
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = originalHtml;
                });
            } else {
                // 如果按钮找不到或已disabled，直接调用API
                fetch(`/api/publisher/publish/${sensorType}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(data.message, 'success');
                    } else {
                        showToast('发布失败: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('发布失败:', error);
                    showToast('发布失败: ' + error.message, 'danger');
                });
            }
        }
    </script>
</body>
</html>