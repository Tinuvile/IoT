<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT数据发布者 - 实时监控</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .realtime-data {
            font-family: 'Monaco', 'Consolas', monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            font-size: 14px;
        }
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-satellite-dish text-primary me-2"></i>
                IoT数据发布者
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-2 sidebar px-0">
                <div class="p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-home me-2"></i>首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="publisher.html">
                                <i class="fas fa-paper-plane me-2"></i>数据发布
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="monitor.html">
                                <i class="fas fa-chart-line me-2"></i>实时监控
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <hr class="text-white-50">
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="layout.html">
                                <i class="fas fa-heartbeat me-2"></i>系统布局
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showToast('系统信息功能需要服务器支持', 'info')">
                                <i class="fas fa-cogs me-2"></i>系统信息
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main class="col-md-10 main-content p-4">
                <!-- 页面标题 -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h3 mb-0">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            实时监控面板
                        </h2>
                        <p class="text-muted mb-0">系统运行状态和数据流监控</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="toggleAutoRefresh()">
                            <i class="fas fa-sync me-2" id="refresh-icon"></i>
                            <span id="refresh-text">自动刷新: 开启</span>
                        </button>
                    </div>
                </div>

                <!-- 实时状态卡片 -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">系统状态</h6>
                                        <h4 class="mb-0" id="system-status">运行中</h4>
                                    </div>
                                    <div class="text-primary">
                                        <i class="fas fa-server fa-2x"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-success">
                                        <i class="fas fa-circle me-1"></i>
                                        在线
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">MQTT连接</h6>
                                        <h4 class="mb-0" id="mqtt-status">检查中...</h4>
                                    </div>
                                    <div class="text-success">
                                        <i class="fas fa-network-wired fa-2x"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small id="mqtt-broker" class="text-muted">检查中...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">发布速率</h6>
                                        <h4 class="mb-0" id="current-rate">0 条/秒</h4>
                                    </div>
                                    <div class="text-info">
                                        <i class="fas fa-tachometer-alt fa-2x"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        平均: <span id="avg-rate">0</span> 条/秒
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card status-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="text-muted mb-1">总发布量</h6>
                                        <h4 class="mb-0" id="total-count">-</h4>
                                    </div>
                                    <div class="text-warning">
                                        <i class="fas fa-paper-plane fa-2x"></i>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        错误: <span id="error-count">0</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="row mb-4">
                    <!-- 发布速率趋势 -->
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-area me-2"></i>发布速率趋势
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="rateChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 传感器类型分布 -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>传感器类型分布
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="sensorChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据统计表格 -->
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>详细统计
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>传感器类型</th>
                                                <th>总数据量</th>
                                                <th>已发布</th>
                                                <th>进度</th>
                                                <th>发布率</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <i class="fas fa-thermometer-half text-danger me-2"></i>
                                                    温度
                                                </td>
                                <td id="temp-total-stat">-</td>
                                <td id="temp-published-stat">-</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                        <div id="temp-progress-stat" class="progress-bar bg-danger" role="progressbar" style="width: 0%">
                                            <span id="temp-percentage">0%</span>
                                        </div>
                                                    </div>
                                                </td>
                                                <td><span id="temp-rate" class="badge bg-danger">69.4%</span></td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <i class="fas fa-tint text-primary me-2"></i>
                                                    湿度
                                                </td>
                                <td id="humid-total-stat">-</td>
                                <td id="humid-published-stat">-</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                        <div id="humid-progress-stat" class="progress-bar bg-primary" role="progressbar" style="width: 0%">
                                            <span id="humid-percentage">0%</span>
                                        </div>
                                                    </div>
                                                </td>
                                                <td><span id="humid-rate" class="badge bg-primary">0%</span></td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <i class="fas fa-weight text-success me-2"></i>
                                                    气压
                                                </td>
                                <td id="pressure-total-stat">-</td>
                                <td id="pressure-published-stat">-</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                        <div id="pressure-progress-stat" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                                            <span id="pressure-percentage">0%</span>
                                        </div>
                                                    </div>
                                                </td>
                                                <td><span id="pressure-rate" class="badge bg-success">0%</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 系统信息 -->
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>系统配置
                                </h5>
                            </div>
                            <div class="card-body">
                                <dl class="row">
                                    <dt class="col-sm-6">发布间隔:</dt>
                                    <dd class="col-sm-6" id="config-interval">5000ms</dd>
                                    
                                    <dt class="col-sm-6">批量大小:</dt>
                                    <dd class="col-sm-6" id="config-batch-size">10</dd>
                                    
                                    <dt class="col-sm-6">自动启动:</dt>
                                    <dd class="col-sm-6" id="config-auto-start">否</dd>
                                    
                                    <dt class="col-sm-6">客户端ID:</dt>
                                    <dd class="col-sm-6" id="config-client-id">demo-client</dd>
                                </dl>
                                
                                <hr>
                                
                                <h6>运行时信息</h6>
                                <dl class="row">
                                    <dt class="col-sm-6">启动时间:</dt>
                                    <dd class="col-sm-6" id="start-time">-</dd>
                                    
                                    <dt class="col-sm-6">运行时长:</dt>
                                    <dd class="col-sm-6" id="uptime">-</dd>
                                    
                                    <dt class="col-sm-6">最后发布:</dt>
                                    <dd class="col-sm-6" id="last-publish">-</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 实时日志 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-terminal me-2"></i>实时活动日志
                                </h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                                    <i class="fas fa-trash me-1"></i>清空日志
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="activity-log" class="realtime-data" style="height: 200px; overflow-y: auto;">
                                    <div class="text-muted p-3">等待活动日志...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript -->
    <script>
        let rateChart, sensorChart;
        let rateData = [];
        let rateLabels = [];
        let autoRefreshEnabled = true;
        let refreshInterval;
        let rateHistory = [];
        
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }
        
        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // 工具函数：显示Toast消息
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // 3秒后自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // 创建Toast容器
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            startAutoRefresh();
            fetchSystemInfo();
            fetchPublishStatus();
            addLogEntry('INFO', '监控面板已初始化');
        });
        
        // 初始化图表
        function initCharts() {
            // 发布速率趋势图
            const rateCtx = document.getElementById('rateChart').getContext('2d');
            rateChart = new Chart(rateCtx, {
                type: 'line',
                data: {
                    labels: rateLabels,
                    datasets: [{
                        label: '发布速率 (条/秒)',
                        data: rateData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '发布速率 (条/秒)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // 传感器类型分布饼图
            const sensorCtx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(sensorCtx, {
                type: 'doughnut',
                data: {
                    labels: ['温度', '湿度', '气压'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // 开始自动刷新
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    fetchSystemInfo();
                    fetchPublishStatus();
                }
            }, 2000);
        }
        
        // 工具函数：格式化数字
        function formatNumber(num) {
            return new Intl.NumberFormat('zh-CN').format(num);
        }
        
        // 工具函数：格式化时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '未知';
            return new Date(dateTimeStr).toLocaleString('zh-CN');
        }
        
        // 格式化持续时间
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}h ${minutes}m ${secs}s`;
        }
        
        // 更新速率图表
        function updateRateChart(rate) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
            
            // 确保rate是数字类型
            let numericRate = 0;
            if (typeof rate === 'number') {
                numericRate = rate;
            } else if (typeof rate === 'string') {
                numericRate = parseFloat(rate) || 0;
            } else if (rate && typeof rate === 'object') {
                numericRate = parseFloat(rate.value || rate.rate || rate) || 0;
            }
            
            rateData.push(numericRate);
            rateLabels.push(timeStr);
            
            // 保持最近20个数据点
            if (rateData.length > 20) {
                rateData.shift();
                rateLabels.shift();
            }
            
            rateChart.update('none');
        }
        
        // 更新传感器分布图表
        function updateSensorChart(tempCount, humidCount, pressureCount) {
            // 确保都是数字类型
            const numericTempCount = parseInt(tempCount) || 0;
            const numericHumidCount = parseInt(humidCount) || 0;
            const numericPressureCount = parseInt(pressureCount) || 0;
            
            sensorChart.data.datasets[0].data = [numericTempCount, numericHumidCount, numericPressureCount];
            sensorChart.update('none');
        }
        
        // 添加活动日志条目
        function addLogEntry(level, message) {
            const logContainer = document.getElementById('activity-log');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
            
            const levelColors = {
                'INFO': 'text-info',
                'WARN': 'text-warning',
                'ERROR': 'text-danger',
                'SUCCESS': 'text-success'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1';
            logEntry.innerHTML = `
                <span class="text-muted">[${timeStr}]</span>
                <span class="${levelColors[level] || 'text-info'}">[${level}]</span>
                ${message}
            `;
            
            // 移除"等待活动日志"提示
            const waitingMsg = logContainer.querySelector('.text-muted');
            if (waitingMsg && waitingMsg.textContent.includes('等待活动日志')) {
                waitingMsg.remove();
            }
            
            logContainer.appendChild(logEntry);
            
            // 保持最近50条日志
            const logs = logContainer.children;
            if (logs.length > 50) {
                logContainer.removeChild(logs[0]);
            }
            
            // 自动滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 切换自动刷新
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const refreshText = document.getElementById('refresh-text');
            const refreshIcon = document.getElementById('refresh-icon');
            
            if (autoRefreshEnabled) {
                refreshText.textContent = '自动刷新: 开启';
                refreshIcon.className = 'fas fa-sync me-2';
                addLogEntry('INFO', '自动刷新已开启');
            } else {
                refreshText.textContent = '自动刷新: 关闭';
                refreshIcon.className = 'fas fa-pause me-2';
                addLogEntry('WARN', '自动刷新已关闭');
            }
        }
        
        // 清空日志
        function clearLog() {
            const logContainer = document.getElementById('activity-log');
            logContainer.innerHTML = '<div class="text-muted p-3">日志已清空</div>';
            addLogEntry('INFO', '日志已清空');
        }
        
        // 获取系统信息
        function fetchSystemInfo() {
            fetch('/api/publisher/system-info')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateSystemInfo(data);
                    addLogEntry('SUCCESS', '系统信息已更新');
                })
                .catch(error => {
                    console.error('获取系统信息失败:', error);
                    addLogEntry('ERROR', '获取系统信息失败: ' + error.message);
                    
                    // 设置离线状态显示
                    document.getElementById('mqtt-status').textContent = '检查中...';
                    document.getElementById('mqtt-broker').textContent = '无法连接到服务器';
                });
        }
        
        // 获取发布状态
        function fetchPublishStatus() {
            fetch('/api/publisher/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updatePublishStatusData(data);
                    
                    // 只在数据有实际变化时添加日志，避免日志过多
                    if (data.publish_rate > 0) {
                        addLogEntry('INFO', `发布状态更新 - 速率: ${data.publish_rate}条/秒，总计: ${data.total_published}条`);
                    }
                })
                .catch(error => {
                    console.error('获取发布状态失败:', error);
                    addLogEntry('ERROR', '获取发布状态失败: ' + error.message);
                    
                    // 设置离线状态显示
                    document.getElementById('current-rate').textContent = '- 条/秒';
                    document.getElementById('total-count').textContent = '-';
                });
        }
        
        // 更新系统信息显示
        function updateSystemInfo(systemInfo) {
            // 更新MQTT状态
            const mqttStatus = document.getElementById('mqtt-status');
            const mqttBroker = document.getElementById('mqtt-broker');
            
            if (systemInfo.mqttConnected) {
                mqttStatus.textContent = '已连接';
                mqttStatus.className = 'text-success mb-0';
                mqttBroker.textContent = systemInfo.mqttConnectionInfo?.brokerUrl || '本地MQTT服务器';
            } else {
                mqttStatus.textContent = '未连接';
                mqttStatus.className = 'text-danger mb-0';
                mqttBroker.textContent = '连接失败';
            }
            
            // 更新系统配置信息
            document.getElementById('config-interval').textContent = systemInfo.publishInterval + 'ms';
            document.getElementById('config-batch-size').textContent = systemInfo.batchSize;
            document.getElementById('config-client-id').textContent = systemInfo.mqttConnectionInfo?.clientId || 'demo-client';
            document.getElementById('config-auto-start').textContent = systemInfo.autoStart ? '是' : '否';
            
            // 更新运行时信息
            if (systemInfo.startTime) {
                document.getElementById('start-time').textContent = formatDateTime(systemInfo.startTime);
                
                // 计算运行时长
                const startTime = new Date(systemInfo.startTime);
                const now = new Date();
                const uptimeSeconds = Math.floor((now - startTime) / 1000);
                document.getElementById('uptime').textContent = formatDuration(uptimeSeconds);
            }
            
            // 更新详细统计
            document.getElementById('temp-total-stat').textContent = formatNumber(systemInfo.temperatureCount);
            document.getElementById('humid-total-stat').textContent = formatNumber(systemInfo.humidityCount);
            document.getElementById('pressure-total-stat').textContent = formatNumber(systemInfo.pressureCount);
        }
        
        // 更新发布状态数据
        function updatePublishStatusData(status) {
            // 更新系统状态
            document.getElementById('system-status').textContent = status.is_running ? '运行中' : '已停止';
            
            // 更新发布速率
            document.getElementById('current-rate').textContent = status.publish_rate + ' 条/秒';
            document.getElementById('avg-rate').textContent = status.publish_rate;
            
            // 更新总发布量
            document.getElementById('total-count').textContent = formatNumber(status.total_published);
            
            // 更新详细统计中的已发布数量
            document.getElementById('temp-published-stat').textContent = formatNumber(status.temperature_count);
            document.getElementById('humid-published-stat').textContent = formatNumber(status.humidity_count);  
            document.getElementById('pressure-published-stat').textContent = formatNumber(status.pressure_count);
            
            // 更新进度条
            updateProgressBars(status);
            
            // 更新图表
            updateRateChart(status.publish_rate);
            updateSensorChart(status.temperature_count, status.humidity_count, status.pressure_count);
            
            // 更新最后发布时间
            if (status.last_publish_time) {
                document.getElementById('last-publish').textContent = formatDateTime(status.last_publish_time);
            } else if (status.is_running) {
                document.getElementById('last-publish').textContent = '正在发布...';
            } else {
                document.getElementById('last-publish').textContent = '暂未发布';
            }
        }
        
        // 更新进度条
        function updateProgressBars(status) {
            // 从已获取的系统信息中获取总数据量，如果没有则使用默认值
            const tempTotalElement = document.getElementById('temp-total-stat');
            const humidTotalElement = document.getElementById('humid-total-stat');  
            const pressureTotalElement = document.getElementById('pressure-total-stat');
            
            const tempTotal = parseInt(tempTotalElement.textContent.replace(/,/g, '')) || 1000;
            const humidTotal = parseInt(humidTotalElement.textContent.replace(/,/g, '')) || 1000;
            const pressureTotal = parseInt(pressureTotalElement.textContent.replace(/,/g, '')) || 1000;
            
            const tempPercent = Math.min(100, (status.temperature_count / tempTotal) * 100);
            const humidPercent = Math.min(100, (status.humidity_count / humidTotal) * 100);
            const pressurePercent = Math.min(100, (status.pressure_count / pressureTotal) * 100);
            
            // 更新温度进度
            document.getElementById('temp-progress-stat').style.width = tempPercent + '%';
            document.getElementById('temp-percentage').textContent = tempPercent.toFixed(1) + '%';
            document.getElementById('temp-rate').textContent = tempPercent.toFixed(1) + '%';
            
            // 更新湿度进度
            document.getElementById('humid-progress-stat').style.width = humidPercent + '%';
            document.getElementById('humid-percentage').textContent = humidPercent.toFixed(1) + '%';
            document.getElementById('humid-rate').textContent = humidPercent.toFixed(1) + '%';
            
            // 更新气压进度
            document.getElementById('pressure-progress-stat').style.width = pressurePercent + '%';
            document.getElementById('pressure-percentage').textContent = pressurePercent.toFixed(1) + '%';
            document.getElementById('pressure-rate').textContent = pressurePercent.toFixed(1) + '%';
        }
    </script>
</body>
</html>