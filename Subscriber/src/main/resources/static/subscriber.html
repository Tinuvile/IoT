<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT数据订阅者 - 数据订阅</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .sidebar .nav-link {
            color: #ecf0f1;
            border-radius: 8px;
            margin: 2px 0;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: #3498db;
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .navbar-brand {
            font-weight: bold;
            color: #2c3e50 !important;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-satellite-dish text-success me-2"></i>
                IoT数据订阅者
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-2 sidebar px-0">
                <div class="p-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fas fa-home me-2"></i>首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="subscriber.html">
                                <i class="fas fa-download me-2"></i>数据订阅
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="monitor.html">
                                <i class="fas fa-chart-line me-2"></i>数据监控
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <hr class="text-white-50">
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="layout.html">
                                <i class="fas fa-heartbeat me-2"></i>系统布局
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showToast('系统信息功能需要服务器支持', 'info')">
                                <i class="fas fa-cogs me-2"></i>系统信息
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main class="col-md-10 main-content p-4">
                <!-- 页面标题 -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="h3 mb-0">
                            <i class="fas fa-download text-success me-2"></i>
                            数据订阅控制
                        </h2>
                        <p class="text-muted mb-0">高级订阅控制和实时监控</p>
                    </div>
                </div>

                <!-- 订阅控制面板 -->
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-play-circle me-2"></i>订阅控制
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-success btn-lg w-100" id="start-subscribe-btn" onclick="startSubscribing()">
                                            <i class="fas fa-play me-2"></i>开始订阅
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-danger btn-lg w-100" id="stop-subscribe-btn" onclick="stopSubscribing()" disabled>
                                            <i class="fas fa-stop me-2"></i>停止订阅
                                        </button>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-danger w-100" onclick="viewSensorData('temperature')">
                                            <i class="fas fa-thermometer-half me-2"></i>查看温度
                                        </button>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-primary w-100" onclick="viewSensorData('humidity')">
                                            <i class="fas fa-tint me-2"></i>查看湿度
                                        </button>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <button class="btn btn-outline-success w-100" onclick="viewSensorData('pressure')">
                                            <i class="fas fa-weight me-2"></i>查看气压
                                        </button>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <button class="btn btn-warning w-100" onclick="clearAllData()">
                                            <i class="fas fa-trash me-2"></i>清空数据
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-info w-100" onclick="refreshData()">
                                            <i class="fas fa-sync me-2"></i>刷新数据
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 订阅状态 -->
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>当前状态
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <h6 class="text-muted">订阅状态</h6>
                                        <h4 id="subscribe-status-text" class="text-danger">未订阅</h4>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <h6 class="text-muted">MQTT连接</h6>
                                        <h4 id="mqtt-connection-text" class="text-warning">检查中</h4>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <h6 class="text-muted">运行时长</h6>
                                        <h4 id="running-time" class="text-info">00:00:00</h4>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <h6 class="text-muted">总接收量</h6>
                                        <h4 id="total-received-text" class="text-success">-</h4>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="text-muted">订阅主题</h6>
                                    <span id="subscribe-topics" class="badge bg-secondary fs-6">iot/sensors/+</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 传感器数据统计 -->
                <div class="row mb-4">
                    <div class="col-lg-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <div class="mb-3">
                                    <i class="fas fa-thermometer-half fa-4x text-danger"></i>
                                </div>
                                <h5 class="card-title">温度数据</h5>
                                <div class="row">
                                    <div class="col-6">
                                        <h6 class="text-muted">已接收</h6>
                                        <h4 id="temp-received" class="text-danger">-</h4>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-muted">最新值</h6>
                                        <h4 id="temp-latest" class="text-dark">-</h4>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 10px;">
                                    <div id="temp-progress" class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <div class="mb-3">
                                    <i class="fas fa-tint fa-4x text-primary"></i>
                                </div>
                                <h5 class="card-title">湿度数据</h5>
                                <div class="row">
                                    <div class="col-6">
                                        <h6 class="text-muted">已接收</h6>
                                        <h4 id="humid-received" class="text-primary">-</h4>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-muted">最新值</h6>
                                        <h4 id="humid-latest" class="text-dark">-</h4>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 10px;">
                                    <div id="humid-progress" class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <div class="mb-3">
                                    <i class="fas fa-weight fa-4x text-success"></i>
                                </div>
                                <h5 class="card-title">气压数据</h5>
                                <div class="row">
                                    <div class="col-6">
                                        <h6 class="text-muted">已接收</h6>
                                        <h4 id="pressure-received" class="text-success">-</h4>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-muted">最新值</h6>
                                        <h4 id="pressure-latest" class="text-dark">-</h4>
                                    </div>
                                </div>
                                <div class="progress mt-3" style="height: 10px;">
                                    <div id="pressure-progress" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 实时接收图表 -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>实时接收速率
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="receiveRateChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>接收日志
                                </h5>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                <div id="receive-log" class="small">
                                    <p class="text-muted">暂无接收记录</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript -->
    <script>
        let receiveRateChart;
        let receiveRateData = [];
        let receiveRateLabels = [];
        let startTime = null;
        let isSubscribing = false;
        let lastLogTime = 0;
        
        // 按钮状态锁，防止轮询干扰loading状态
        let isStartButtonLoading = false;
        let isStopButtonLoading = false;
        
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('zh-CN');
        }
        
        // 每秒更新时间
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // 工具函数：显示Toast消息
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // 创建Toast容器
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initReceiveRateChart();
            fetchSystemInfo();
            fetchSubscriberStatus();
            fetchLatestData();
            
            // 定时更新数据
            setInterval(fetchSystemInfo, 5000);
            setInterval(fetchSubscriberStatus, 2000);
            setInterval(fetchLatestData, 3000);
            // 每秒更新运行时长
            setInterval(updateRunningTime, 1000);
        });
        
        // 初始化接收速率图表
        function initReceiveRateChart() {
            const ctx = document.getElementById('receiveRateChart').getContext('2d');
            receiveRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: receiveRateLabels,
                    datasets: [{
                        label: '接收速率 (条/分钟)',
                        data: receiveRateData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '接收速率 (条/分钟)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // 获取系统信息
        function fetchSystemInfo() {
            fetch('/api/subscriber/system-info')
                .then(response => response.json())
                .then(data => updateSystemInfo(data))
                .catch(error => console.error('获取系统信息失败:', error));
        }
        
        // 获取订阅状态
        function fetchSubscriberStatus() {
            fetch('/api/subscriber/status')
                .then(response => response.json())
                .then(data => updateSubscriberStatus(data))
                .catch(error => console.error('获取订阅状态失败:', error));
        }

        // 获取最新数据
        function fetchLatestData() {
            fetch('/api/subscriber/data/latest?limit=1')
                .then(response => response.json())
                .then(data => updateLatestData(data))
                .catch(error => console.error('获取最新数据失败:', error));
        }
        
        // 更新系统信息
        function updateSystemInfo(systemInfo) {
            // 更新MQTT连接状态
            const mqttConnectionText = document.getElementById('mqtt-connection-text');
            if (systemInfo.mqttConnected) {
                mqttConnectionText.textContent = '已连接';
                mqttConnectionText.className = 'text-success';
            } else {
                mqttConnectionText.textContent = '未连接';
                mqttConnectionText.className = 'text-danger';
            }
            
            // 更新传感器数据统计
            document.getElementById('temp-received').textContent = formatNumber(systemInfo.temperatureCount || 0);
            document.getElementById('humid-received').textContent = formatNumber(systemInfo.humidityCount || 0);
            document.getElementById('pressure-received').textContent = formatNumber(systemInfo.pressureCount || 0);
            
            // 更新总接收量
            const totalReceived = (systemInfo.temperatureCount || 0) + 
                                (systemInfo.humidityCount || 0) + 
                                (systemInfo.pressureCount || 0);
            document.getElementById('total-received-text').textContent = formatNumber(totalReceived);
        }
        
        // 更新订阅状态
        function updateSubscriberStatus(status) {
            // 更新基本状态
            const subscribeStatusText = document.getElementById('subscribe-status-text');
            const runningTimeEl = document.getElementById('running-time');
            const startBtn = document.getElementById('start-subscribe-btn');
            const stopBtn = document.getElementById('stop-subscribe-btn');
            
            if (status.subscribing) {
                subscribeStatusText.textContent = '订阅中';
                subscribeStatusText.className = 'text-success';
                isSubscribing = true;
                
                // 只有在按钮不在loading状态时才更新
                if (!isStartButtonLoading) {
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
                }
                if (!isStopButtonLoading) {
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
                }
                
                // 从后端获取开始时间，如果后端有的话
                if (status.start_time) {
                    const backendStartTime = new Date(status.start_time);
                    if (!startTime || Math.abs(startTime - backendStartTime) > 1000) {
                        startTime = backendStartTime;
                    }
                } else if (!startTime) {
                    // 如果后端没有开始时间，使用当前时间
                    startTime = new Date();
                }
            } else {
                subscribeStatusText.textContent = '未订阅';
                subscribeStatusText.className = 'text-danger';
                isSubscribing = false;
                
                // 只有在按钮不在loading状态时才更新
                if (!isStartButtonLoading) {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
                }
                if (!isStopButtonLoading) {
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
                }
                
                startTime = null;
            }
            
            // 更新运行时长（由定时器每秒调用updateRunningTime）
            updateRunningTime();
            
            // 更新接收速率图表
            if (isSubscribing) {
                const currentTotal = status.total_received || 
                                  ((status.temperatureCount || 0) + 
                                   (status.humidityCount || 0) + 
                                   (status.pressureCount || 0));
                updateReceiveRateChart(currentTotal);
            }
        }
        
        // 更新运行时长（每秒调用）
        function updateRunningTime() {
            const runningTimeEl = document.getElementById('running-time');
            if (startTime && isSubscribing) {
                const now = new Date();
                const elapsed = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                runningTimeEl.textContent = 
                    String(hours).padStart(2, '0') + ':' +
                    String(minutes).padStart(2, '0') + ':' +
                    String(seconds).padStart(2, '0');
            } else {
                runningTimeEl.textContent = '00:00:00';
            }
        }

        // 更新最新数据
        function updateLatestData(data) {
            if (data.temperature && data.temperature.length > 0) {
                document.getElementById('temp-latest').textContent = data.temperature[0].value + '°C';
            } else {
                document.getElementById('temp-latest').textContent = '-';
            }
            
            if (data.humidity && data.humidity.length > 0) {
                document.getElementById('humid-latest').textContent = data.humidity[0].value + '%';
            } else {
                document.getElementById('humid-latest').textContent = '-';
            }
            
            if (data.pressure && data.pressure.length > 0) {
                document.getElementById('pressure-latest').textContent = data.pressure[0].value + 'hPa';
            } else {
                document.getElementById('pressure-latest').textContent = '-';
            }
            
            // 如果正在订阅且有新数据，添加到日志
            if (isSubscribing) {
                const now = Date.now();
                if (now - lastLogTime > 5000) { // 每5秒最多记录一次
                    lastLogTime = now;
                    addReceiveLog(data);
                }
            }
        }
        
        // 开始订阅
        function startSubscribing() {
            const button = document.getElementById('start-subscribe-btn');
            isStartButtonLoading = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>启动中...';

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 9000);

            fetch('/api/subscriber/start', {
                method: 'POST',
                signal: controller.signal
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('订阅服务已启动', 'success');
                    startTime = new Date();
                    // 立即刷新状态以更新按钮
                    setTimeout(() => {
                        fetchSubscriberStatus();
                    }, 500);
                } else {
                    showToast('启动失败: ' + data.message, 'danger');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
                }
            })
            .catch(error => {
                console.error('启动失败:', error);
                const msg = (error && error.name === 'AbortError')
                    ? '启动订阅超时：请检查MQTT是否已启动'
                    : ('启动失败: ' + (error.message || '网络错误'));
                showToast(msg, 'danger');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play me-2"></i>开始订阅';
            })
            .finally(() => {
                clearTimeout(timeoutId);
                isStartButtonLoading = false;
            });
        }
        
        // 停止订阅
        function stopSubscribing() {
            const button = document.getElementById('stop-subscribe-btn');
            isStopButtonLoading = true;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>停止中...';

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 9000);

            fetch('/api/subscriber/stop', {
                method: 'POST',
                signal: controller.signal
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('订阅服务已停止', 'success');
                    startTime = null;
                    // 立即刷新状态以更新按钮
                    setTimeout(() => {
                        fetchSubscriberStatus();
                    }, 500);
                } else {
                    showToast('停止失败: ' + data.message, 'danger');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
                }
            })
            .catch(error => {
                console.error('停止失败:', error);
                const msg = (error && error.name === 'AbortError')
                    ? '停止订阅超时：请稍后重试'
                    : ('停止失败: ' + (error.message || '网络错误'));
                showToast(msg, 'danger');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-stop me-2"></i>停止订阅';
            })
            .finally(() => {
                clearTimeout(timeoutId);
                isStopButtonLoading = false;
            });
        }
        
        // 查看传感器数据
        function viewSensorData(sensorType) {
            window.location.href = `monitor.html#${sensorType}`;
        }
        
        // 工具函数：格式化数字
        function formatNumber(num) {
            return new Intl.NumberFormat('zh-CN').format(num);
        }
        
        // 更新接收速率图表
        function updateReceiveRateChart(totalCount) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
            
            // 计算每分钟接收速率
            let rate = 0;
            if (receiveRateData.length > 0) {
                const lastCount = receiveRateData[receiveRateData.length - 1].totalCount || 0;
                const timeDiff = 1; // 假设每次调用间隔约为1分钟（实际可能更短）
                rate = Math.max(0, totalCount - lastCount);
            }
            
            receiveRateData.push({rate: rate, totalCount: totalCount});
            receiveRateLabels.push(timeStr);
            
            if (receiveRateData.length > 20) {
                receiveRateData.shift();
                receiveRateLabels.shift();
            }
            
            // 更新图表数据
            receiveRateChart.data.datasets[0].data = receiveRateData.map(item => item.rate);
            receiveRateChart.update('none');
        }
        
        // 添加接收日志
        function addReceiveLog(data) {
            const logContainer = document.getElementById('receive-log');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', {hour12: false});
            
            let hasData = false;
            let dataInfo = [];
            
            if (data.temperature && data.temperature.length > 0) {
                hasData = true;
                dataInfo.push(`温度: ${data.temperature[0].value}°C`);
            }
            if (data.humidity && data.humidity.length > 0) {
                hasData = true;
                dataInfo.push(`湿度: ${data.humidity[0].value}%`);
            }
            if (data.pressure && data.pressure.length > 0) {
                hasData = true;
                dataInfo.push(`气压: ${data.pressure[0].value}hPa`);
            }
            
            if (hasData) {
                const logEntry = document.createElement('div');
                logEntry.className = 'mb-2 p-2 bg-light rounded';
                logEntry.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">${timeStr}</span>
                        <span class="badge bg-success">接收数据</span>
                    </div>
                    <div class="small text-muted">
                        ${dataInfo.join(' | ')}
                    </div>
                `;
                
                // 移除"暂无记录"提示
                const noLogMsg = logContainer.querySelector('.text-muted');
                if (noLogMsg && noLogMsg.textContent.includes('暂无接收记录')) {
                    noLogMsg.remove();
                }
                
                logContainer.insertBefore(logEntry, logContainer.firstChild);
                
                // 保持最近10条日志
                const logs = logContainer.children;
                if (logs.length > 10) {
                    logContainer.removeChild(logs[logs.length - 1]);
                }
            }
        }
        
        // 清空所有数据
        function clearAllData() {
            if (confirm('确定要清空所有存储的数据吗？此操作不可恢复！')) {
                // 找到清空按钮
                const clearButtons = document.querySelectorAll('button[onclick="clearAllData()"]');
                const clearButton = clearButtons[0];
                
                if (clearButton) {
                    const originalHtml = clearButton.innerHTML;
                    clearButton.disabled = true;
                    clearButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>清空中...';
                    
                    fetch('/api/subscriber/storage/clear', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('所有数据已清空', 'success');
                            // 清空图表数据
                            receiveRateData.length = 0;
                            receiveRateLabels.length = 0;
                            receiveRateChart.update();
                            
                            // 清空接收日志
                            const logContainer = document.getElementById('receive-log');
                            logContainer.innerHTML = '<p class="text-muted">暂无接收记录</p>';
                        } else {
                            showToast('清空失败: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('清空失败:', error);
                        showToast('清空失败', 'danger');
                    })
                    .finally(() => {
                        clearButton.disabled = false;
                        clearButton.innerHTML = originalHtml;
                    });
                }
            }
        }
        
        // 刷新数据
        function refreshData() {
            fetchSystemInfo();
            fetchSubscriberStatus();
            fetchLatestData();
            showToast('数据已刷新', 'info');
        }
    </script>
</body>
</html>
